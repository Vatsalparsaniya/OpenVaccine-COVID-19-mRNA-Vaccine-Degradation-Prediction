
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuration &#8212; üçÄ Co-weed&#39;19</title>
    
  <link rel="stylesheet" href="_static/css/index.d431a4ee1c1efae0e38bdfebc22debff.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/sphinx-book-theme.bfb7730f9caf2ec0b46a44615585038c.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.30270b6e4c972e43c488.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-2 bd-sidebar site-navigation show single-page" id="site-navigation">
    
</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/openvaccine-model-training-augmentation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/openvaccine-model-training-augmentation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/executablebooks/jupyter-book/blob/master/openvaccine-model-training-augmentation.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Configuration
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-seed">
   Set Seed
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#used-columns">
   Used Columns
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-and-preprocess-data">
   Load and preprocess data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reduce-train-data">
   Reduce Train Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#public-and-private-sets-have-different-sequence-lengths-so-we-will-preprocess-them-separately-and-load-models-of-different-tensor-shapes">
     Public and private sets have different sequence lengths, so we will preprocess them separately and load models of different tensor shapes.
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#loss-function">
   loss Function
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-rate-schedulars">
   Learning Rate Schedulars
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rampup-decy-lr-schedule">
     Rampup decy lr Schedule
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cosine-schedule-with-warmup">
     Cosine schedule with warmup
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#different-layers">
   Different Layers
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-building">
   Model Building
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#build-and-train-model">
   Build and train model
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#add-augmentation-data">
   Add Augmentation Data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stratify-group-based-on-structure-and-sn-filter">
   stratify_group Based on structure and SN_Filter
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-oof-score">
   Calculate OOF Score :
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overall-oof-score">
     Overall OOF Score
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#oof-sn-filter-1">
     OOF  SN_filter == 1
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#oof-sn-filter-0">
     OOF  SN_filter == 0
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#save-stacking-data">
   Save Stacking Data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#submit-to-kaggle">
   Submit To Kaggle
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Vatsal&#39;s Code</span>
</pre></div>
</div>
</div>
</div>
<p>This notebook shows you how to build a model for predicting degradation at various locations along RNA sequence.</p>
<ul class="simple">
<li><p>We will first pre-process and tokenize the sequence, secondary structure and loop type.</p></li>
<li><p>Then, we will use all the information to train a model on degradations recorded by the researchers from OpenVaccine.</p></li>
<li><p>Finally, we run our model on the public test set (shorter sequences) and the private test set (longer sequences), and submit the predictions.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%capture</span>
<span class="c1"># !pip install forgi</span>
<span class="c1"># !yes Y |conda install -c bioconda viennarna</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="c1"># from forgi.graph import bulge_graph</span>
<span class="c1"># import forgi.visual.mplotlib as fvm</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">tensorflow.keras.backend</span> <span class="k">as</span> <span class="nn">K</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">tensorflow.keras.layers</span> <span class="k">as</span> <span class="nn">L</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">tensorflow_addons</span> <span class="k">as</span> <span class="nn">tfa</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">combinations_with_replacement</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">KFold</span><span class="p">,</span>  <span class="n">StratifiedKFold</span><span class="p">,</span><span class="n">GroupKFold</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="k">import</span> <span class="n">plot_model</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="k">import</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Back</span><span class="p">,</span> <span class="n">Style</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="mi">86</span><span class="n">f721f41c04</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="ne">---&gt; </span><span class="mi">11</span> <span class="kn">import</span> <span class="nn">tensorflow.keras.backend</span> <span class="kn">as</span> <span class="nn">K</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="kn">import</span> <span class="nn">plotly.express</span> <span class="kn">as</span> <span class="nn">px</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">import</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">as</span> <span class="nn">L</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;tensorflow&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="configuration">
<h1>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">###### USE DIFFERENT SEED FOR DIFFERENT STRATIFIED KFOLD</span>
<span class="n">SEED</span> <span class="o">=</span> <span class="mi">53</span>

<span class="c1">###### NUMBER OF FOLDS. USE 3, 5, 7,... </span>
<span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span>

<span class="c1">###### TRAIN DEBUG</span>
<span class="n">debug</span><span class="o">=</span><span class="kc">True</span>

<span class="c1">###### APPLY WINDOW FEATURES</span>
<span class="n">Window_features</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">###### Number of Feature Given to Model</span>
<span class="c1"># cat_feature = 3  ## ( Categorical Features Only)</span>
<span class="c1"># num_features = 1  ## ( Numerical Features Only)</span>

<span class="c1">###### Model Configuration ######</span>

<span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;GG&quot;</span>                <span class="c1">## MODEL NAME (Files will save according to this )</span>
<span class="n">epochs</span><span class="o">=</span><span class="mi">100</span>              <span class="c1">## NUMBER OF EPOCHS MODEL TRAIN IN EACH FOLD. USE 3, 5, 7,... </span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>                 <span class="c1">## NUMBER OF BATCH_SIZE USE 16, 32, 64, 128,...</span>
<span class="n">n_layers</span> <span class="o">=</span> <span class="mi">2</span>                  <span class="c1">## Number of Layers Present in model # ex. 3 Layer of GRU Model</span>
<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GRU&quot;</span><span class="p">,</span><span class="s2">&quot;GRU&quot;</span><span class="p">]</span>   <span class="c1">## Stacking sequence of GRU and LSTM (list of length == n_layers)</span>
<span class="n">hidden_dim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>    <span class="c1">## Hidden Dimension in Model (Default : [128,128]) (list of length == n_layers)</span>
<span class="n">dropout</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>       <span class="c1">## 1.0 means no dropout, and 0.0 means no outputs from the layer.</span>
<span class="n">sp_dropout</span> <span class="o">=</span> <span class="mf">0.2</span>                <span class="c1">## SpatialDropout1D (Fraction of the input units to drop) [https://stackoverflow.com/a/55244985]</span>
<span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">250</span>                  <span class="c1">## Output Dimention of Embedding Layer (Default : 75)</span>
<span class="n">num_hidden_units</span> <span class="o">=</span> <span class="mi">8</span>      <span class="c1">## Number of GRU units after num_input layer</span>


<span class="c1">###### LR Schedular ######</span>

<span class="n">Cosine_Schedule</span> <span class="o">=</span> <span class="kc">True</span>         <span class="c1">## cosine_schedule Rate</span>
<span class="n">Rampup_decy_lr</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1">## Rampup decy lr Schedule</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-seed">
<h1>Set Seed<a class="headerlink" href="#set-seed" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>   
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>   
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>   
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>   
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_DETERMINISTIC_OPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    
<span class="n">seed_everything</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="used-columns">
<h1>Used Columns<a class="headerlink" href="#used-columns" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reactivity&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_Mg_pH10&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_Mg_50C&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_pH10&#39;</span><span class="p">,</span> <span class="s1">&#39;deg_50C&#39;</span><span class="p">]</span>
<span class="n">window_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span><span class="s1">&#39;structure&#39;</span><span class="p">,</span><span class="s1">&#39;predicted_loop_type&#39;</span><span class="p">]</span>

<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;structure&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted_loop_type&#39;</span><span class="p">,]</span>
<span class="c1">#                        &#39;predicted_loop_index&#39;]</span>

<span class="n">cat_feature</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="k">if</span> <span class="n">Window_features</span><span class="p">:</span>
    <span class="n">cat_feature</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_columns</span><span class="p">)</span>

<span class="n">numerical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BPPS_Max&#39;</span><span class="p">,</span><span class="s1">&#39;BPPS_nb&#39;</span><span class="p">,</span> <span class="s1">&#39;BPPS_sum&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;positional_entropy&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;stems&#39;</span><span class="p">,</span> <span class="s1">&#39;interior_loops&#39;</span><span class="p">,</span> <span class="s1">&#39;multiloops&#39;</span><span class="p">,</span><span class="c1">#&#39;hairpin loops&#39;, &#39;fiveprimes&#39;, &#39;threeprimes&#39;, </span>
                      <span class="s1">&#39;A_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;G_percent&#39;</span><span class="p">,</span><span class="s1">&#39;C_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;U_percent&#39;</span><span class="p">,</span> 
                      <span class="s1">&#39;U-G&#39;</span><span class="p">,</span> <span class="s1">&#39;C-G&#39;</span><span class="p">,</span> <span class="s1">&#39;U-A&#39;</span><span class="p">,</span> <span class="s1">&#39;G-C&#39;</span><span class="p">,</span> <span class="s1">&#39;A-U&#39;</span><span class="p">,</span> <span class="s1">&#39;G-U&#39;</span><span class="p">,</span> 
<span class="c1">#                       &#39;E&#39;, &#39;S&#39;, &#39;H&#39;, &#39;B&#39;, &#39;X&#39;, &#39;I&#39;, &#39;M&#39;, </span>
                      <span class="s1">&#39;pair_map&#39;</span><span class="p">,</span> <span class="s1">&#39;pair_distance&#39;</span><span class="p">,</span> <span class="p">]</span>
    

<span class="n">num_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numerical_features</span><span class="p">)</span>  <span class="c1">## ( Numerical Features Only)</span>

<span class="n">feature_cols</span> <span class="o">=</span> <span class="n">categorical_features</span> <span class="o">+</span> <span class="n">numerical_features</span>
<span class="n">pred_col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pred_&quot;</span><span class="o">+</span><span class="n">c_name</span> <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">target_cols</span><span class="p">]</span>

<span class="n">target_eval_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;reactivity&#39;</span><span class="p">,</span><span class="s1">&#39;deg_Mg_pH10&#39;</span><span class="p">,</span><span class="s1">&#39;deg_Mg_50C&#39;</span><span class="p">]</span>
<span class="n">pred_eval_col</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pred_&quot;</span><span class="o">+</span><span class="n">c_name</span> <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">target_eval_col</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-and-preprocess-data">
<h1>Load and preprocess data<a class="headerlink" href="#load-and-preprocess-data" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/kaggle/input/stanford-covid-vaccine/&#39;</span>
<span class="n">fearure_data_path</span> <span class="o">=</span> <span class="s1">&#39;../input/openvaccine/&#39;</span>

<span class="c1"># train  = pd.read_csv(fearure_data_path+&#39;train.csv&#39;)</span>
<span class="c1"># test = pd.read_csv(fearure_data_path+&#39;test.csv&#39;)</span>

<span class="n">train</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">fearure_data_path</span><span class="o">+</span><span class="s1">&#39;train.json&#39;</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">fearure_data_path</span><span class="o">+</span><span class="s1">&#39;test.json&#39;</span><span class="p">)</span>

<span class="c1"># train_j = pd.read_json(data_dir + &#39;train.json&#39;, lines=True)</span>
<span class="c1"># test_j = pd.read_json(data_dir + &#39;test.json&#39;, lines=True)</span>
<span class="n">sample_sub</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_dir</span> <span class="o">+</span> <span class="s1">&#39;sample_submission.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># train = train[train[&#39;SN_filter&#39;] == 1]</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pair_feature</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">its</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">([</span><span class="s1">&#39;_&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">arr</span><span class="p">[:])</span> <span class="p">,</span><span class="nb">iter</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="p">])]</span>
    <span class="n">list_touple</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">its</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span><span class="n">list_touple</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_categorical_inputs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">categorical_features</span><span class="p">,</span><span class="n">Window_features</span><span class="o">=</span><span class="n">Window_features</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">Window_features</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">window_columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pair_&quot;</span><span class="o">+</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pair_feature</span><span class="p">)</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pair_&quot;</span><span class="o">+</span><span class="n">c</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">seq</span><span class="p">:</span> <span class="p">[</span><span class="n">token2int</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">])</span>
            <span class="o">.</span><span class="n">values</span>
            <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_numerical_inputs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">numerical_features</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We will use this dictionary to map each character to an integer</span>
<span class="c1"># so that it can be used as an input in keras</span>
<span class="c1"># ().ACGUBEHIMSXshftim0123456789[]{}&#39;_,</span>
<span class="n">token_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;().ACGUESHBXIM&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">Window_features</span><span class="p">:</span>
    <span class="n">comb</span> <span class="o">=</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;_().ACGUESHBXIM&#39;</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> 
    <span class="n">token_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span><span class="n">comb</span><span class="p">))))</span>

<span class="n">token2int</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">token_list</span><span class="p">)))}</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;token_list Size :&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">))</span>
    
<span class="n">train_inputs_all_cat</span> <span class="o">=</span> <span class="n">preprocess_categorical_inputs</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="n">train_inputs_all_num</span> <span class="o">=</span> <span class="n">preprocess_numerical_inputs</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">numerical_features</span><span class="p">)</span>
<span class="n">train_labels_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">dtype</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train categorical Features Shape : &quot;</span><span class="p">,</span><span class="n">train_inputs_all_cat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train numerical Features Shape : &quot;</span><span class="p">,</span><span class="n">train_inputs_all_num</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train labels Shape : &quot;</span><span class="p">,</span><span class="n">train_labels_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>token_list Size : 239
Train categorical Features Shape :  (3718, 107, 6)
Train numerical Features Shape :  (3718, 107, 19)
Train labels Shape :  (3718, 68, 5)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reduce-train-data">
<h1>Reduce Train Data<a class="headerlink" href="#reduce-train-data" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># train_inputs_all_cat = train_inputs_all_cat[:,:68,:]</span>
<span class="c1"># train_inputs_all_num = train_inputs_all_num[:,:68,:]</span>
<span class="c1"># train_labels_all = train_labels_all[:,:68,:]</span>

<span class="c1"># print(&quot;Train categorical Features Shape : &quot;,train_inputs_all_cat.shape)</span>
<span class="c1"># print(&quot;Train numerical Features Shape : &quot;,train_inputs_all_num.shape)</span>
<span class="c1"># print(&quot;Train labels Shape : &quot;,train_labels_all.shape)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="public-and-private-sets-have-different-sequence-lengths-so-we-will-preprocess-them-separately-and-load-models-of-different-tensor-shapes">
<h2>Public and private sets have different sequence lengths, so we will preprocess them separately and load models of different tensor shapes.<a class="headerlink" href="#public-and-private-sets-have-different-sequence-lengths-so-we-will-preprocess-them-separately-and-load-models-of-different-tensor-shapes" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">public_df</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;seq_length == 107&quot;</span><span class="p">)</span>
<span class="n">private_df</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;seq_length == 130&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;public_df : &quot;</span><span class="p">,</span><span class="n">public_df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;private_df : &quot;</span><span class="p">,</span><span class="n">private_df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">public_inputs_cat</span> <span class="o">=</span> <span class="n">preprocess_categorical_inputs</span><span class="p">(</span><span class="n">public_df</span><span class="p">)</span>
<span class="n">private_inputs_cat</span> <span class="o">=</span> <span class="n">preprocess_categorical_inputs</span><span class="p">(</span><span class="n">private_df</span><span class="p">)</span>

<span class="n">public_inputs_num</span> <span class="o">=</span> <span class="n">preprocess_numerical_inputs</span><span class="p">(</span><span class="n">public_df</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">numerical_features</span><span class="p">)</span>
<span class="n">private_inputs_num</span> <span class="o">=</span> <span class="n">preprocess_numerical_inputs</span><span class="p">(</span><span class="n">private_df</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">numerical_features</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Public categorical Features Shape : &quot;</span><span class="p">,</span><span class="n">public_inputs_cat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Public numerical Features Shape : &quot;</span><span class="p">,</span><span class="n">public_inputs_num</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Private categorical Features Shape : &quot;</span><span class="p">,</span><span class="n">private_inputs_cat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Private numerical Features Shape : &quot;</span><span class="p">,</span><span class="n">private_inputs_num</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>public_df :  (1040, 38)
private_df :  (6850, 38)
Public categorical Features Shape :  (1040, 107, 6)
Public numerical Features Shape :  (1040, 107, 19)
Private categorical Features Shape :  (6850, 130, 6)
Private numerical Features Shape :  (6850, 130, 19)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="loss-function">
<h1>loss Function<a class="headerlink" href="#loss-function" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Custom Loss Function for [&#39;reactivity&#39;,&#39;deg_Mg_pH10&#39;,&#39;deg_Mg_50C&#39;] target Columns</span>

<span class="c1"># def rmse(y_actual, y_pred):</span>
<span class="c1">#     mse = tf.keras.losses.mean_squared_error(y_actual, y_pred)</span>
<span class="c1">#     return K.sqrt(mse)</span>

<span class="c1"># def MCRMSE(y_actual, y_pred, num_scored=3):</span>
<span class="c1">#     score = 0</span>
<span class="c1">#     for i in range(num_scored):</span>
<span class="c1">#         score += rmse(y_actual[:,:, i], y_pred[:,:, i]) / num_scored</span>
<span class="c1">#     return score</span>

<span class="k">def</span> <span class="nf">MCRMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">colwise_mse</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_true</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">colwise_mse</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="learning-rate-schedulars">
<h1>Learning Rate Schedulars<a class="headerlink" href="#learning-rate-schedulars" title="Permalink to this headline">¬∂</a></h1>
<div class="section" id="rampup-decy-lr-schedule">
<h2>Rampup decy lr Schedule<a class="headerlink" href="#rampup-decy-lr-schedule" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_lr_callback</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">lr_start</span>   <span class="o">=</span> <span class="mf">0.00001</span>
    <span class="n">lr_max</span>     <span class="o">=</span> <span class="mf">0.004</span>
    <span class="n">lr_min</span>     <span class="o">=</span> <span class="mf">0.00005</span>
    <span class="n">lr_ramp_ep</span> <span class="o">=</span> <span class="mi">45</span>
    <span class="n">lr_sus_ep</span>  <span class="o">=</span> <span class="mi">2</span>
    <span class="n">lr_decay</span>   <span class="o">=</span> <span class="mf">0.8</span>
   
    <span class="k">def</span> <span class="nf">lrfn</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">lr_ramp_ep</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lr_max</span> <span class="o">-</span> <span class="n">lr_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">lr_ramp_ep</span> <span class="o">*</span> <span class="n">epoch</span> <span class="o">+</span> <span class="n">lr_start</span>
            
        <span class="k">elif</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">lr_ramp_ep</span> <span class="o">+</span> <span class="n">lr_sus_ep</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="n">lr_max</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lr_max</span> <span class="o">-</span> <span class="n">lr_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">lr_decay</span><span class="o">**</span><span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="n">lr_ramp_ep</span> <span class="o">-</span> <span class="n">lr_sus_ep</span><span class="p">)</span> <span class="o">+</span> <span class="n">lr_min</span>
            
        <span class="k">return</span> <span class="n">lr</span>

    <span class="n">lr_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">lrfn</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lr_callback</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="cosine-schedule-with-warmup">
<h2>Cosine schedule with warmup<a class="headerlink" href="#cosine-schedule-with-warmup" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_cosine_schedule_with_warmup</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span><span class="n">num_warmup_steps</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="p">,</span> <span class="n">num_cycles</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified version of the get_cosine_schedule_with_warmup from huggingface.</span>
<span class="sd">    (https://huggingface.co/transformers/_modules/transformers/optimization.html#get_cosine_schedule_with_warmup)</span>

<span class="sd">    Create a schedule with a learning rate that decreases following the</span>
<span class="sd">    values of the cosine function between 0 and `pi * cycles` after a warmup</span>
<span class="sd">    period during which it increases linearly between 0 and 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">lrfn</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="n">num_warmup_steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="p">)))</span> <span class="o">*</span> <span class="n">lr</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="n">num_warmup_steps</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_training_steps</span> <span class="o">-</span> <span class="n">num_warmup_steps</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_cycles</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">progress</span><span class="p">)))</span> <span class="o">*</span> <span class="n">lr</span>

    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">lrfn</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="different-layers">
<h1>Different Layers<a class="headerlink" href="#different-layers" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lstm_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Bidirectional</span><span class="p">(</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span>
                                <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span>
                                <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s1">&#39;orthogonal&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gru_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">L</span><span class="o">.</span><span class="n">Bidirectional</span><span class="p">(</span>
        <span class="n">L</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;orthogonal&#39;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-building">
<h1>Model Building<a class="headerlink" href="#model-building" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def build_model(embed_size, </span>
<span class="c1">#                 seq_len = 107, </span>
<span class="c1">#                 pred_len = 68, </span>
<span class="c1">#                 dropout = dropout, </span>
<span class="c1">#                 sp_dropout = sp_dropout, </span>
<span class="c1">#                 num_features = num_features,</span>
<span class="c1">#                 num_hidden_units = num_hidden_units,</span>
<span class="c1">#                 embed_dim = embed_dim,</span>
<span class="c1">#                 layers = layers, </span>
<span class="c1">#                 hidden_dim = hidden_dim, </span>
<span class="c1">#                 n_layers = n_layers,</span>
<span class="c1">#                 cat_feature = cat_feature):</span>
    
<span class="c1">#     inputs = L.Input(shape=(seq_len, cat_feature),name=&#39;category_input&#39;)</span>
<span class="c1">#     embed = L.Embedding(input_dim=embed_size, output_dim=embed_dim)(inputs)</span>
<span class="c1">#     reshaped = tf.reshape(embed, shape=(-1, embed.shape[1],  embed.shape[2] * embed.shape[3]))</span>
<span class="c1">#     reshaped_conv = tf.keras.layers.Conv1D(filters=512, kernel_size=3,strides=1, padding=&#39;same&#39;, activation=&#39;elu&#39;)(reshaped)</span>
    
<span class="c1">#     numerical_input = L.Input(shape=(seq_len, num_features), name=&#39;numeric_input&#39;)</span>
<span class="c1">#     n_Dense_1 = L.Dense(64)(numerical_input)</span>
<span class="c1">#     n_Dense_2 = L.Dense(128)(n_Dense_1)</span>
<span class="c1">#     numerical_conv = tf.keras.layers.Conv1D(filters=256, kernel_size=4,strides=1, padding=&#39;same&#39;, activation=&#39;elu&#39;)(n_Dense_2)</span>
    
<span class="c1">#     hidden = L.concatenate([reshaped_conv, numerical_conv])</span>
<span class="c1">#     hidden = L.SpatialDropout1D(sp_dropout)(hidden)</span>
    
<span class="c1">#     for x in range(n_layers):</span>
<span class="c1">#         if layers[x] == &quot;GRU&quot;:</span>
<span class="c1">#             hidden = gru_layer(hidden_dim[x], dropout[x])(hidden)</span>
<span class="c1">#         else:</span>
<span class="c1">#             hidden = lstm_layer(hidden_dim[x], dropout[x])(hidden)</span>
            
<span class="c1">#     # Since we are only making predictions on the first part of each sequence, </span>
<span class="c1">#     # we have to truncate it</span>
<span class="c1">#     truncated = hidden[:, :pred_len]</span>
    
<span class="c1">#     out = L.Dense(5)(truncated)</span>
    
<span class="c1">#     model = tf.keras.Model(inputs=[inputs] + [numerical_input], outputs=out)</span>
    
<span class="c1">#     adam = tf.optimizers.Adam()</span>
<span class="c1">#     radam = tfa.optimizers.RectifiedAdam()</span>
<span class="c1">#     lookahead = tfa.optimizers.Lookahead(adam, sync_period=6)</span>
<span class="c1">#     ranger = tfa.optimizers.Lookahead(radam, sync_period=6)</span>
    
<span class="c1">#     model.compile(optimizer=radam, loss=MCRMSE)</span>
    
<span class="c1">#     return model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">embed_size</span><span class="p">,</span> 
                <span class="n">seq_len</span> <span class="o">=</span> <span class="mi">107</span><span class="p">,</span> 
                <span class="n">pred_len</span> <span class="o">=</span> <span class="mi">68</span><span class="p">,</span> 
                <span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">,</span> 
                <span class="n">sp_dropout</span> <span class="o">=</span> <span class="n">sp_dropout</span><span class="p">,</span> 
                <span class="n">num_features</span> <span class="o">=</span> <span class="n">num_features</span><span class="p">,</span>
                <span class="n">num_hidden_units</span> <span class="o">=</span> <span class="n">num_hidden_units</span><span class="p">,</span>
                <span class="n">embed_dim</span> <span class="o">=</span> <span class="n">embed_dim</span><span class="p">,</span>
                <span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span><span class="p">,</span> 
                <span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span><span class="p">,</span> 
                <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span>
                <span class="n">cat_feature</span> <span class="o">=</span> <span class="n">cat_feature</span><span class="p">):</span>
    
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">cat_feature</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;category_input&#39;</span><span class="p">)</span>
    <span class="n">embed</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">output_dim</span><span class="o">=</span><span class="n">embed_dim</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">reshaped</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">embed</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">embed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">reshaped</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">SpatialDropout1D</span><span class="p">(</span><span class="n">sp_dropout</span><span class="p">)(</span><span class="n">reshaped</span><span class="p">)</span>
    <span class="n">reshaped_conv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">)(</span><span class="n">reshaped</span><span class="p">)</span>
    
    <span class="n">numerical_input</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">num_features</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;numeric_input&#39;</span><span class="p">)</span>
<span class="c1">#     n_Dense_1 = L.Dense(64)(numerical_input)</span>
<span class="c1">#     n_Dense_2 = L.Dense(128)(n_Dense_1)</span>
<span class="c1">#     numerical_conv = tf.keras.layers.Conv1D(filters=256, kernel_size=4,strides=1, padding=&#39;same&#39;, activation=&#39;elu&#39;)(n_Dense_2)</span>
    
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">reshaped_conv</span><span class="p">,</span> <span class="n">numerical_input</span><span class="p">])</span>
    <span class="n">hidden_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">)(</span><span class="n">hidden</span><span class="p">)</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">gru_layer</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)(</span><span class="n">hidden_1</span><span class="p">)</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden_1</span><span class="p">])</span>
<span class="c1">#     hidden = L.SpatialDropout1D(sp_dropout)(hidden)</span>
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">layers</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;GRU&quot;</span><span class="p">:</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="n">gru_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">dropout</span><span class="p">[</span><span class="n">x</span><span class="p">])(</span><span class="n">hidden</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hidden</span> <span class="o">=</span> <span class="n">lstm_layer</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">dropout</span><span class="p">[</span><span class="n">x</span><span class="p">])(</span><span class="n">hidden</span><span class="p">)</span>
        
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">hidden</span><span class="p">,</span> <span class="n">hidden_1</span><span class="p">])</span>
            
    <span class="c1"># Since we are only making predictions on the first part of each sequence, </span>
    <span class="c1"># we have to truncate it</span>
    <span class="n">truncated</span> <span class="o">=</span> <span class="n">hidden</span><span class="p">[:,</span> <span class="p">:</span><span class="n">pred_len</span><span class="p">]</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">)(</span><span class="n">truncated</span><span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">inputs</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">numerical_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
    
    <span class="n">adam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">()</span>
    <span class="n">radam</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RectifiedAdam</span><span class="p">()</span>
    <span class="n">lookahead</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Lookahead</span><span class="p">(</span><span class="n">adam</span><span class="p">,</span> <span class="n">sync_period</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ranger</span> <span class="o">=</span> <span class="n">tfa</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Lookahead</span><span class="p">(</span><span class="n">radam</span><span class="p">,</span> <span class="n">sync_period</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">radam</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">MCRMSE</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="build-and-train-model">
<h1>Build and train model<a class="headerlink" href="#build-and-train-model" title="Permalink to this headline">¬∂</a></h1>
<p>We will train a bi-directional GRU model. It has three layer and has dropout. To learn more about RNNs, LSTM and GRU, please see <a class="reference external" href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">this blog post</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">embed_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">))</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="s1">&#39;model_plot.png&#39;</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_layer_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/openvaccine-model-training-augmentation_35_0.png" src="_images/openvaccine-model-training-augmentation_35_0.png" />
</div>
</div>
</div>
<div class="section" id="add-augmentation-data">
<h1>Add Augmentation Data<a class="headerlink" href="#add-augmentation-data" title="Permalink to this headline">¬∂</a></h1>
</div>
<div class="section" id="stratify-group-based-on-structure-and-sn-filter">
<h1>stratify_group Based on structure and SN_Filter<a class="headerlink" href="#stratify-group-based-on-structure-and-sn-filter" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_stratify_group</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">snf</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">]</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">snf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">snr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="mi">0</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="mi">2</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="mi">4</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mf">5.5</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="mf">5.5</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">snr</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">5</span>
            
    <span class="k">else</span><span class="p">:</span> <span class="c1"># snf == 1</span>
        <span class="k">if</span> <span class="n">snr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="mi">0</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">elif</span> <span class="mi">1</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="mi">2</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">elif</span> <span class="mi">3</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="mi">4</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="k">elif</span> <span class="mi">5</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">elif</span> <span class="mi">6</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">13</span>
        <span class="k">elif</span> <span class="mi">7</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">14</span>
        <span class="k">elif</span> <span class="mi">8</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="k">elif</span> <span class="mi">9</span><span class="o">&lt;=</span> <span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="k">elif</span> <span class="n">snr</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">snr_c</span> <span class="o">=</span> <span class="mi">16</span>
        
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span><span class="n">snr_c</span><span class="p">)</span>

<span class="n">train</span><span class="p">[</span><span class="s1">&#39;stratify_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_stratify_group</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;stratify_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;stratify_group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>

<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">gkf</span> <span class="o">=</span> <span class="n">GroupKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_folds</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_folds</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">n_folds</span><span class="p">))</span>

<span class="k">for</span> <span class="n">Fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">val_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gkf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train_inputs_all_cat</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;stratify_group&#39;</span><span class="p">])):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">45</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###  Fold : &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Fold</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">45</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
    
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
    <span class="n">val_data</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_index</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Augmented data Present in Val Data : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Augmented data Present in Train Data : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">val_data</span> <span class="o">=</span> <span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data Lekage : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])]))</span>
<span class="c1">#     print(train_data[&#39;stratify_group&#39;].unique(),val_data[&#39;stratify_group&#39;].unique())</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of Train Data points : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of val_data Data points : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of unique Structure in Train data : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of unique Structure in val data : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="n">val_data</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train SN_Filter == 1 : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;val_data SN_Filter == 1 : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train SN_Filter == 0 : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;val_data SN_Filter == 0 : &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unique ID :&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train All&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Blue&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>            
    <span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fold : {Fold+1} Signal/Noise &amp; SN_filter == 0&#39;</span><span class="p">)</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train All&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Blue&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>            
    <span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fold : {Fold+1} Signal/Noise &amp; SN_filter == 1&#39;</span><span class="p">)</span>
    
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train All&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Blue&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;signal_to_noise&#39;</span><span class="p">],</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>            
    <span class="n">ax</span><span class="p">[</span><span class="n">Fold</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fold : {Fold+1} Signal/Noise&#39;</span><span class="p">)</span>
            
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  1</span>
<span class=" -Color -Color-Yellow">#############################################</span>

Augmented data Present in Val Data :  302
Augmented data Present in Train Data :  1204
Data Lekage :  0
number of Train Data points :  2974
number of val_data Data points :  442
number of unique Structure in Train data :  2215
number of unique Structure in val data :  319 [33 14 13 13  9]
Train SN_Filter == 1 :  2112
val_data SN_Filter == 1 :  327
Train SN_Filter == 0 :  862
val_data SN_Filter == 0 :  115
Unique ID : 1770

<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  2</span>
<span class=" -Color -Color-Yellow">#############################################</span>

Augmented data Present in Val Data :  301
Augmented data Present in Train Data :  1205
Data Lekage :  0
number of Train Data points :  2974
number of val_data Data points :  443
number of unique Structure in Train data :  2202
number of unique Structure in val data :  333 [49 13 11  6  6]
Train SN_Filter == 1 :  2110
val_data SN_Filter == 1 :  316
Train SN_Filter == 0 :  864
val_data SN_Filter == 0 :  127
Unique ID : 1769

<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  3</span>
<span class=" -Color -Color-Yellow">#############################################</span>

Augmented data Present in Val Data :  301
Augmented data Present in Train Data :  1205
Data Lekage :  0
number of Train Data points :  2974
number of val_data Data points :  443
number of unique Structure in Train data :  2189
number of unique Structure in val data :  341 [39 10 10  8  6]
Train SN_Filter == 1 :  2123
val_data SN_Filter == 1 :  314
Train SN_Filter == 0 :  851
val_data SN_Filter == 0 :  129
Unique ID : 1769

<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  4</span>
<span class=" -Color -Color-Yellow">#############################################</span>

Augmented data Present in Val Data :  301
Augmented data Present in Train Data :  1205
Data Lekage :  0
number of Train Data points :  2975
number of val_data Data points :  442
number of unique Structure in Train data :  2196
number of unique Structure in val data :  336 [48 15  9  5  5]
Train SN_Filter == 1 :  2114
val_data SN_Filter == 1 :  312
Train SN_Filter == 0 :  861
val_data SN_Filter == 0 :  130
Unique ID : 1770

<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  5</span>
<span class=" -Color -Color-Yellow">#############################################</span>

Augmented data Present in Val Data :  301
Augmented data Present in Train Data :  1205
Data Lekage :  0
number of Train Data points :  2975
number of val_data Data points :  442
number of unique Structure in Train data :  2194
number of unique Structure in val data :  324 [38 15 12  7  6]
Train SN_Filter == 1 :  2097
val_data SN_Filter == 1 :  320
Train SN_Filter == 0 :  878
val_data SN_Filter == 0 :  122
Unique ID : 1770
</pre></div>
</div>
<img alt="_images/openvaccine-model-training-augmentation_38_1.png" src="_images/openvaccine-model-training-augmentation_38_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">sample_sub</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">target_cols</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># test dataframe with 0 values</span>

<span class="n">val_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">historys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">oof_preds_all</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">stacking_pred_all</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">gkf</span> <span class="o">=</span> <span class="n">GroupKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">n_folds</span><span class="p">)</span>

<span class="k">for</span> <span class="n">Fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_index</span><span class="p">,</span> <span class="n">val_index</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gkf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train_inputs_all_cat</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;stratify_group&#39;</span><span class="p">])):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">45</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###  Fold : &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Fold</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">45</span><span class="p">);</span><span class="nb">print</span><span class="p">(</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;|| Batch_size: </span><span class="si">{BATCH_SIZE}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">|| n_layers: </span><span class="si">{n_layers}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">|| embed_dim: </span><span class="si">{embed_dim}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;|| cat_feature: </span><span class="si">{cat_feature}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">|| num_features: </span><span class="si">{num_features}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;|| layers : </span><span class="si">{layers}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">|| hidden_dim: </span><span class="si">{hidden_dim}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">|| dropout: </span><span class="si">{dropout}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">|| sp_dropout: </span><span class="si">{sp_dropout}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">]</span>
    <span class="n">val_data</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_index</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|| number Augmented data Present in Val Data : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|| number Augmented data Present in Train Data : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|| Data Lekage : &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])]))</span>
    
    <span class="n">val_data</span> <span class="o">=</span> <span class="n">val_data</span><span class="p">[</span><span class="n">val_data</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">model_train</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">embed_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">))</span>
    <span class="n">model_short</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">embed_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">),</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">107</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">107</span><span class="p">)</span>
    <span class="n">model_long</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">embed_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">token_list</span><span class="p">),</span><span class="n">seq_len</span><span class="o">=</span><span class="mi">130</span><span class="p">,</span> <span class="n">pred_len</span><span class="o">=</span><span class="mi">130</span><span class="p">)</span>

    <span class="n">train_inputs_cat</span> <span class="o">=</span> <span class="n">preprocess_categorical_inputs</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="n">train_inputs_num</span> <span class="o">=</span> <span class="n">preprocess_numerical_inputs</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">numerical_features</span><span class="p">)</span>
    <span class="n">train_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">dtype</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="n">val_inputs_cat</span> <span class="o">=</span> <span class="n">preprocess_categorical_inputs</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="n">val_inputs_num</span> <span class="o">=</span> <span class="n">preprocess_numerical_inputs</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span><span class="n">cols</span><span class="o">=</span><span class="n">numerical_features</span><span class="p">)</span>
    <span class="n">val_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">dtype</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
<span class="c1">#     train_inputs_cat, train_labels = train_inputs_all_cat[train_index], train_labels_all[train_index]</span>
<span class="c1">#     val_inputs_cat, val_labels = train_inputs_all_cat[val_index], train_labels_all[val_index]</span>
<span class="c1">#     train_inputs_num, val_inputs_num = train_inputs_all_num[train_index],train_inputs_all_num[val_index]</span>
    
    <span class="c1"># csv_logger</span>
    <span class="n">csv_logger</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">CSVLogger</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fold_</span><span class="si">{Fold}</span><span class="s1">_log.csv&#39;</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># SAVE BEST MODEL EACH FOLD</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{model_name}</span><span class="s1">_Fold_</span><span class="si">{Fold}</span><span class="s1">.h5&#39;</span><span class="p">,</span> 
                                                    <span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span> 
                                                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> 
                                                    <span class="n">save_freq</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">Cosine_Schedule</span><span class="p">:</span>
        <span class="c1">#cosine Callback</span>
        <span class="n">lr_schedule</span><span class="o">=</span> <span class="n">get_cosine_schedule_with_warmup</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">Rampup_decy_lr</span> <span class="p">:</span> 
        <span class="c1"># Rampup decy lr </span>
        <span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">get_lr_callback</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">()</span>
        
    <span class="n">history</span> <span class="o">=</span> <span class="n">model_train</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;numeric_input&#39;</span><span class="p">:</span> <span class="n">train_inputs_num</span><span class="p">,</span>
           <span class="s1">&#39;category_input&#39;</span><span class="p">:</span> <span class="n">train_inputs_cat</span><span class="p">}</span> <span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> 
        <span class="n">validation_data</span><span class="o">=</span><span class="p">({</span><span class="s1">&#39;numeric_input&#39;</span><span class="p">:</span> <span class="n">val_inputs_num</span><span class="p">,</span>
                          <span class="s1">&#39;category_input&#39;</span><span class="p">:</span> <span class="n">val_inputs_cat</span><span class="p">}</span>
                         <span class="p">,</span><span class="n">val_labels</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> 
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">lr_schedule</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">,</span> <span class="n">csv_logger</span><span class="p">,</span><span class="n">lr_schedule</span><span class="p">],</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Min Validation Loss : &quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Min Validation Epoch : &quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span> <span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">val_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]))</span>
    <span class="n">historys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

    <span class="n">model_short</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{model_name}</span><span class="s1">_Fold_</span><span class="si">{Fold}</span><span class="s1">.h5&#39;</span><span class="p">)</span>
    <span class="n">model_long</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{model_name}</span><span class="s1">_Fold_</span><span class="si">{Fold}</span><span class="s1">.h5&#39;</span><span class="p">)</span>
    
    <span class="n">public_preds</span> <span class="o">=</span> <span class="n">model_short</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s1">&#39;numeric_input&#39;</span><span class="p">:</span> <span class="n">public_inputs_num</span><span class="p">,</span>
                                        <span class="s1">&#39;category_input&#39;</span><span class="p">:</span> <span class="n">public_inputs_cat</span><span class="p">})</span>
    
    <span class="n">private_preds</span> <span class="o">=</span> <span class="n">model_long</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s1">&#39;numeric_input&#39;</span><span class="p">:</span> <span class="n">private_inputs_num</span><span class="p">,</span>
                                        <span class="s1">&#39;category_input&#39;</span><span class="p">:</span> <span class="n">private_inputs_cat</span><span class="p">})</span>
    
    <span class="n">oof_preds</span> <span class="o">=</span> <span class="n">model_train</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s1">&#39;numeric_input&#39;</span><span class="p">:</span> <span class="n">val_inputs_num</span><span class="p">,</span>
                                        <span class="s1">&#39;category_input&#39;</span><span class="p">:</span> <span class="n">val_inputs_cat</span><span class="p">})</span>
    
    <span class="n">stacking_pred</span> <span class="o">=</span> <span class="n">model_short</span><span class="o">.</span><span class="n">predict</span><span class="p">({</span><span class="s1">&#39;numeric_input&#39;</span><span class="p">:</span> <span class="n">val_inputs_num</span><span class="p">,</span>
                                        <span class="s1">&#39;category_input&#39;</span><span class="p">:</span> <span class="n">val_inputs_cat</span><span class="p">})</span>
    
    <span class="n">preds_model</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">preds</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">public_df</span><span class="p">,</span> <span class="n">public_preds</span><span class="p">),</span> <span class="p">(</span><span class="n">private_df</span><span class="p">,</span> <span class="n">private_preds</span><span class="p">)]:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="n">single_pred</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">single_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">single_pred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">target_cols</span><span class="p">)</span>
            <span class="n">single_df</span><span class="p">[</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{uid}</span><span class="s1">_</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            
            <span class="n">preds_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_df</span><span class="p">)</span>
    
    <span class="n">preds_model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">preds_model</span><span class="p">)</span>
    <span class="n">preds_model_df</span> <span class="o">=</span> <span class="n">preds_model_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">submission</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span> <span class="o">+=</span> <span class="n">preds_model_df</span><span class="p">[</span><span class="n">target_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">n_folds</span>
    
    <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">preds</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">oof_preds</span><span class="p">)]:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="n">single_pred</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">single_label</span> <span class="o">=</span> <span class="n">val_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">single_label_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">single_label</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">target_cols</span><span class="p">)</span>
            <span class="n">single_label_df</span><span class="p">[</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{uid}</span><span class="s1">_</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_label_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">single_label_df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{uid}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_label_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">single_label_df</span><span class="p">[</span><span class="s1">&#39;s_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_label_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">single_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">single_pred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pred_col_names</span><span class="p">)</span>
            <span class="n">single_df</span><span class="p">[</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{uid}</span><span class="s1">_</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            
            <span class="n">single_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">single_label_df</span><span class="p">,</span><span class="n">single_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;id_seqpos&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            
            <span class="n">oof_preds_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_df</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">preds</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">stacking_pred</span><span class="p">)]:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="n">single_pred</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="c1">#             single_label = val_labels[i]</span>
<span class="c1">#             single_label_df = pd.DataFrame(single_label, columns=target_cols)</span>
<span class="c1">#             single_label_df[&#39;id_seqpos&#39;] = [f&#39;{uid}_{x}&#39; for x in range(single_label_df.shape[0])]</span>
<span class="c1">#             single_label_df[&#39;id&#39;] = [f&#39;{uid}&#39; for x in range(single_label_df.shape[0])]</span>
<span class="c1">#             single_label_df[&#39;s_id&#39;] = [x for x in range(single_label_df.shape[0])]</span>
            <span class="n">single_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">single_pred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pred_col_names</span><span class="p">)</span>
            <span class="n">single_df</span><span class="p">[</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{uid}</span><span class="s1">_</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">single_df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">uid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">stacking_pred_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_df</span><span class="p">)</span>
        
    <span class="c1"># PLOT TRAINING</span>
    <span class="n">history_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fold_</span><span class="si">{Fold}</span><span class="s1">_log.csv&#39;</span><span class="p">)</span>
    <span class="n">EPOCHS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history_data</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">])</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;history&#39;</span><span class="p">:</span><span class="n">history_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)})</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">),</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Learning Rate&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#ff7f0e&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="p">);</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">xdist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ydist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.03</span><span class="o">*</span><span class="n">xdist</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="mf">0.13</span><span class="o">*</span><span class="n">ydist</span><span class="p">,</span><span class="n">f</span><span class="s1">&#39;Max Learning Rate : </span><span class="si">{y}</span><span class="s1">&#39;</span> <span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Learning Rate&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">),</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2ca02c&#39;</span><span class="p">)</span>
    <span class="n">plt2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">),</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#d62728&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span> <span class="p">);</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">ydist</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#d62728&#39;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.03</span><span class="o">*</span><span class="n">xdist</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">ydist</span><span class="p">,</span><span class="s1">&#39;min loss&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;Model Name : </span><span class="si">{model_name}</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;|| Fold : {Fold+1} | Batch_size: </span><span class="si">{BATCH_SIZE}</span><span class="s2"> | num_features: </span><span class="si">{num_features}</span><span class="s2"> | cat_feature: </span><span class="si">{cat_feature}</span><span class="s2"> |n_layers: </span><span class="si">{n_layers}</span><span class="s2"> | embed_dim: </span><span class="si">{embed_dim}</span><span class="s2"> ||&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;|| layers : </span><span class="si">{layers}</span><span class="s2"> | hidden_dim: </span><span class="si">{hidden_dim}</span><span class="s2"> | dropout: </span><span class="si">{dropout}</span><span class="s2"> | sp_dropout: </span><span class="si">{sp_dropout}</span><span class="s2"> ||&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Fold_{Fold+1}.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="n">submission</span><span class="p">[</span><span class="s2">&quot;id_seqpos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds_model_df</span><span class="o">.</span><span class="n">index</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sample_sub</span><span class="p">[</span><span class="s2">&quot;id_seqpos&quot;</span><span class="p">],</span> <span class="n">submission</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;id_seqpos&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="n">OOF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">oof_preds_all</span><span class="p">)</span>
<span class="n">stacking_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">stacking_pred_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  1</span>
<span class=" -Color -Color-Yellow">#############################################</span>

|| Batch_size: 32 
|| n_layers: 2 
|| embed_dim: 250
|| cat_feature: 6 
|| num_features: 19
|| layers : [&#39;GRU&#39;, &#39;GRU&#39;] 
|| hidden_dim: [128, 128] 
|| dropout: [0.5, 0.5] 
|| sp_dropout: 0.2
|| number Augmented data Present in Val Data :  302
|| number Augmented data Present in Train Data :  1204
|| Data Lekage :  0
Epoch 1/100
93/93 [==============================] - 9s 95ms/step - loss: 0.6279 - val_loss: 0.6366
Epoch 2/100
93/93 [==============================] - 7s 70ms/step - loss: 0.4501 - val_loss: 0.4061
Epoch 3/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3717 - val_loss: 0.3577
Epoch 4/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3460 - val_loss: 0.3414
Epoch 5/100
93/93 [==============================] - 7s 70ms/step - loss: 0.3366 - val_loss: 0.3358
Epoch 6/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3305 - val_loss: 0.3327
Epoch 7/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3250 - val_loss: 0.3241
Epoch 8/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3186 - val_loss: 0.3162
Epoch 9/100
93/93 [==============================] - 7s 76ms/step - loss: 0.3110 - val_loss: 0.3074
Epoch 10/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3005 - val_loss: 0.2966
Epoch 11/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2912 - val_loss: 0.2878
Epoch 12/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2822 - val_loss: 0.2827
Epoch 13/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2778 - val_loss: 0.2735
Epoch 14/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2711 - val_loss: 0.2735
Epoch 15/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2683 - val_loss: 0.2649
Epoch 16/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2630 - val_loss: 0.2652
Epoch 17/100
93/93 [==============================] - 7s 76ms/step - loss: 0.2576 - val_loss: 0.2560
Epoch 18/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2529 - val_loss: 0.2535
Epoch 19/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2496 - val_loss: 0.2533
Epoch 20/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2460 - val_loss: 0.2503
Epoch 21/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2429 - val_loss: 0.2469
Epoch 22/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2402 - val_loss: 0.2445
Epoch 23/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2353 - val_loss: 0.2436
Epoch 24/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2304 - val_loss: 0.2390
Epoch 25/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2270 - val_loss: 0.2380
Epoch 26/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2233 - val_loss: 0.2357
Epoch 27/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2206 - val_loss: 0.2359
Epoch 28/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2180 - val_loss: 0.2337
Epoch 29/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2152 - val_loss: 0.2333
Epoch 30/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2133 - val_loss: 0.2331
Epoch 31/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2121 - val_loss: 0.2320
Epoch 32/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2119 - val_loss: 0.2316
Epoch 33/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2117 - val_loss: 0.2314
Epoch 34/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2119 - val_loss: 0.2313
Epoch 35/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2123 - val_loss: 0.2320
Epoch 36/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2133 - val_loss: 0.2329
Epoch 37/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2150 - val_loss: 0.2334
Epoch 38/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2155 - val_loss: 0.2331
Epoch 39/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2167 - val_loss: 0.2388
Epoch 40/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2171 - val_loss: 0.2355
Epoch 41/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2164 - val_loss: 0.2354
Epoch 42/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2149 - val_loss: 0.2371
Epoch 43/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2142 - val_loss: 0.2386
Epoch 44/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2132 - val_loss: 0.2322
Epoch 45/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2092 - val_loss: 0.2311
Epoch 46/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2056 - val_loss: 0.2365
Epoch 47/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2032 - val_loss: 0.2332
Epoch 48/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2003 - val_loss: 0.2300
Epoch 49/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1971 - val_loss: 0.2282
Epoch 50/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1946 - val_loss: 0.2255
Epoch 51/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1918 - val_loss: 0.2249
Epoch 52/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1897 - val_loss: 0.2249
Epoch 53/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1886 - val_loss: 0.2242
Epoch 54/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1875 - val_loss: 0.2239
Epoch 55/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1869 - val_loss: 0.2239
Epoch 56/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1870 - val_loss: 0.2239
Epoch 57/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1874 - val_loss: 0.2235
Epoch 58/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1880 - val_loss: 0.2244
Epoch 59/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1888 - val_loss: 0.2254
Epoch 60/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1901 - val_loss: 0.2258
Epoch 61/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1913 - val_loss: 0.2262
Epoch 62/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1923 - val_loss: 0.2274
Epoch 63/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1944 - val_loss: 0.2292
Epoch 64/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1946 - val_loss: 0.2289
Epoch 65/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1951 - val_loss: 0.2290
Epoch 66/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1948 - val_loss: 0.2304
Epoch 67/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1928 - val_loss: 0.2278
Epoch 68/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1916 - val_loss: 0.2271
Epoch 69/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1900 - val_loss: 0.2291
Epoch 70/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1869 - val_loss: 0.2275
Epoch 71/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1846 - val_loss: 0.2253
Epoch 72/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1814 - val_loss: 0.2243
Epoch 73/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1792 - val_loss: 0.2237
Epoch 74/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1771 - val_loss: 0.2232
Epoch 75/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1752 - val_loss: 0.2223
Epoch 76/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1739 - val_loss: 0.2222
Epoch 77/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1735 - val_loss: 0.2219
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 78/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1729 - val_loss: 0.2219
Epoch 79/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1732 - val_loss: 0.2217
Epoch 80/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1734 - val_loss: 0.2216
Epoch 81/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1739 - val_loss: 0.2227
Epoch 82/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1747 - val_loss: 0.2225
Epoch 83/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1759 - val_loss: 0.2235
Epoch 84/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1773 - val_loss: 0.2248
Epoch 85/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1794 - val_loss: 0.2298
Epoch 86/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1806 - val_loss: 0.2263
Epoch 87/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1824 - val_loss: 0.2282
Epoch 88/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1831 - val_loss: 0.2273
Epoch 89/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1830 - val_loss: 0.2299
Epoch 90/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1826 - val_loss: 0.2270
Epoch 91/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1803 - val_loss: 0.2287
Epoch 92/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1791 - val_loss: 0.2270
Epoch 93/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1773 - val_loss: 0.2237
Epoch 94/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1739 - val_loss: 0.2260
Epoch 95/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1711 - val_loss: 0.2232
Epoch 96/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1694 - val_loss: 0.2222
Epoch 97/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1675 - val_loss: 0.2228
Epoch 98/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1658 - val_loss: 0.2213
Epoch 99/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1649 - val_loss: 0.2206
Epoch 100/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1642 - val_loss: 0.2203
Min Validation Loss :  0.22029303014278412
Min Validation Epoch :  100
</pre></div>
</div>
<img alt="_images/openvaccine-model-training-augmentation_39_2.png" src="_images/openvaccine-model-training-augmentation_39_2.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  2</span>
<span class=" -Color -Color-Yellow">#############################################</span>

|| Batch_size: 32 
|| n_layers: 2 
|| embed_dim: 250
|| cat_feature: 6 
|| num_features: 19
|| layers : [&#39;GRU&#39;, &#39;GRU&#39;] 
|| hidden_dim: [128, 128] 
|| dropout: [0.5, 0.5] 
|| sp_dropout: 0.2
|| number Augmented data Present in Val Data :  301
|| number Augmented data Present in Train Data :  1205
|| Data Lekage :  0
Epoch 1/100
93/93 [==============================] - 8s 88ms/step - loss: 0.6235 - val_loss: 0.6195
Epoch 2/100
93/93 [==============================] - 7s 70ms/step - loss: 0.4504 - val_loss: 0.3994
Epoch 3/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3697 - val_loss: 0.3514
Epoch 4/100
93/93 [==============================] - 6s 70ms/step - loss: 0.3459 - val_loss: 0.3387
Epoch 5/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3374 - val_loss: 0.3332
Epoch 6/100
93/93 [==============================] - 6s 69ms/step - loss: 0.3305 - val_loss: 0.3275
Epoch 7/100
93/93 [==============================] - 7s 70ms/step - loss: 0.3249 - val_loss: 0.3231
Epoch 8/100
93/93 [==============================] - 7s 75ms/step - loss: 0.3169 - val_loss: 0.3136
Epoch 9/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3102 - val_loss: 0.3034
Epoch 10/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2995 - val_loss: 0.2934
Epoch 11/100
93/93 [==============================] - 6s 69ms/step - loss: 0.2897 - val_loss: 0.2845
Epoch 12/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2831 - val_loss: 0.2810
Epoch 13/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2771 - val_loss: 0.2802
Epoch 14/100
93/93 [==============================] - 6s 70ms/step - loss: 0.2724 - val_loss: 0.2734
Epoch 15/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2666 - val_loss: 0.2621
Epoch 16/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2628 - val_loss: 0.2612
Epoch 17/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2594 - val_loss: 0.2630
Epoch 18/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2528 - val_loss: 0.2529
Epoch 19/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2506 - val_loss: 0.2541
Epoch 20/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2469 - val_loss: 0.2525
Epoch 21/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2432 - val_loss: 0.2489
Epoch 22/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2402 - val_loss: 0.2497
Epoch 23/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2362 - val_loss: 0.2477
Epoch 24/100
93/93 [==============================] - 6s 70ms/step - loss: 0.2322 - val_loss: 0.2432
Epoch 25/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2282 - val_loss: 0.2397
Epoch 26/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2244 - val_loss: 0.2379
Epoch 27/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2211 - val_loss: 0.2359
Epoch 28/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2184 - val_loss: 0.2353
Epoch 29/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2159 - val_loss: 0.2325
Epoch 30/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2142 - val_loss: 0.2316
Epoch 31/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2127 - val_loss: 0.2314
Epoch 32/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2121 - val_loss: 0.2313
Epoch 33/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2120 - val_loss: 0.2313
Epoch 34/100
93/93 [==============================] - 6s 69ms/step - loss: 0.2125 - val_loss: 0.2320
Epoch 35/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2130 - val_loss: 0.2322
Epoch 36/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2141 - val_loss: 0.2329
Epoch 37/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2146 - val_loss: 0.2359
Epoch 38/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2161 - val_loss: 0.2358
Epoch 39/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2168 - val_loss: 0.2337
Epoch 40/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2181 - val_loss: 0.2358
Epoch 41/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2173 - val_loss: 0.2365
Epoch 42/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2150 - val_loss: 0.2378
Epoch 43/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2135 - val_loss: 0.2387
Epoch 44/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2131 - val_loss: 0.2345
Epoch 45/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2084 - val_loss: 0.2335
Epoch 46/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2058 - val_loss: 0.2328
Epoch 47/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2028 - val_loss: 0.2319
Epoch 48/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2004 - val_loss: 0.2284
Epoch 49/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1968 - val_loss: 0.2270
Epoch 50/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1943 - val_loss: 0.2278
Epoch 51/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1915 - val_loss: 0.2264
Epoch 52/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1892 - val_loss: 0.2260
Epoch 53/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1881 - val_loss: 0.2249
Epoch 54/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1871 - val_loss: 0.2244
Epoch 55/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1866 - val_loss: 0.2243
Epoch 56/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1865 - val_loss: 0.2243
Epoch 57/100
93/93 [==============================] - 6s 70ms/step - loss: 0.1869 - val_loss: 0.2242
Epoch 58/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1876 - val_loss: 0.2252
Epoch 59/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1883 - val_loss: 0.2254
Epoch 60/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1896 - val_loss: 0.2278
Epoch 61/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1914 - val_loss: 0.2277
Epoch 62/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1926 - val_loss: 0.2284
Epoch 63/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1933 - val_loss: 0.2293
Epoch 64/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1939 - val_loss: 0.2318
Epoch 65/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1955 - val_loss: 0.2360
Epoch 66/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1943 - val_loss: 0.2299
Epoch 67/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1930 - val_loss: 0.2290
Epoch 68/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1913 - val_loss: 0.2295
Epoch 69/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1887 - val_loss: 0.2268
Epoch 70/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1860 - val_loss: 0.2275
Epoch 71/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1839 - val_loss: 0.2266
Epoch 72/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1811 - val_loss: 0.2254
Epoch 73/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1784 - val_loss: 0.2243
Epoch 74/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1763 - val_loss: 0.2233
Epoch 75/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1745 - val_loss: 0.2226
Epoch 76/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1733 - val_loss: 0.2217
Epoch 77/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1723 - val_loss: 0.2220
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 78/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1723 - val_loss: 0.2220
Epoch 79/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1724 - val_loss: 0.2218
Epoch 80/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1727 - val_loss: 0.2216
Epoch 81/100
93/93 [==============================] - 6s 69ms/step - loss: 0.1729 - val_loss: 0.2225
Epoch 82/100
93/93 [==============================] - 6s 69ms/step - loss: 0.1740 - val_loss: 0.2224
Epoch 83/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1751 - val_loss: 0.2233
Epoch 84/100
93/93 [==============================] - 6s 68ms/step - loss: 0.1765 - val_loss: 0.2243
Epoch 85/100
93/93 [==============================] - 6s 69ms/step - loss: 0.1783 - val_loss: 0.2244
Epoch 86/100
93/93 [==============================] - 6s 69ms/step - loss: 0.1801 - val_loss: 0.2249
Epoch 87/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1817 - val_loss: 0.2265
Epoch 88/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1830 - val_loss: 0.2288
Epoch 89/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1826 - val_loss: 0.2280
Epoch 90/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1818 - val_loss: 0.2281
Epoch 91/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1803 - val_loss: 0.2266
Epoch 92/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1783 - val_loss: 0.2264
Epoch 93/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1765 - val_loss: 0.2253
Epoch 94/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1732 - val_loss: 0.2238
Epoch 95/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1708 - val_loss: 0.2225
Epoch 96/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1684 - val_loss: 0.2221
Epoch 97/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1666 - val_loss: 0.2210
Epoch 98/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1650 - val_loss: 0.2215
Epoch 99/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1637 - val_loss: 0.2203
Epoch 100/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1631 - val_loss: 0.2207
Min Validation Loss :  0.22031448781490326
Min Validation Epoch :  99
</pre></div>
</div>
<img alt="_images/openvaccine-model-training-augmentation_39_5.png" src="_images/openvaccine-model-training-augmentation_39_5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  3</span>
<span class=" -Color -Color-Yellow">#############################################</span>

|| Batch_size: 32 
|| n_layers: 2 
|| embed_dim: 250
|| cat_feature: 6 
|| num_features: 19
|| layers : [&#39;GRU&#39;, &#39;GRU&#39;] 
|| hidden_dim: [128, 128] 
|| dropout: [0.5, 0.5] 
|| sp_dropout: 0.2
|| number Augmented data Present in Val Data :  301
|| number Augmented data Present in Train Data :  1205
|| Data Lekage :  0
Epoch 1/100
93/93 [==============================] - 8s 89ms/step - loss: 0.6981 - val_loss: 0.6976
Epoch 2/100
93/93 [==============================] - 7s 72ms/step - loss: 0.4715 - val_loss: 0.4076
Epoch 3/100
93/93 [==============================] - 7s 73ms/step - loss: 0.3745 - val_loss: 0.3548
Epoch 4/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3466 - val_loss: 0.3393
Epoch 5/100
93/93 [==============================] - 7s 73ms/step - loss: 0.3366 - val_loss: 0.3329
Epoch 6/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3296 - val_loss: 0.3297
Epoch 7/100
93/93 [==============================] - 7s 74ms/step - loss: 0.3246 - val_loss: 0.3241
Epoch 8/100
93/93 [==============================] - 7s 76ms/step - loss: 0.3170 - val_loss: 0.3183
Epoch 9/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3100 - val_loss: 0.3088
Epoch 10/100
93/93 [==============================] - 7s 73ms/step - loss: 0.3001 - val_loss: 0.2985
Epoch 11/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2909 - val_loss: 0.2920
Epoch 12/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2827 - val_loss: 0.2821
Epoch 13/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2760 - val_loss: 0.2752
Epoch 14/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2713 - val_loss: 0.2693
Epoch 15/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2657 - val_loss: 0.2710
Epoch 16/100
93/93 [==============================] - 7s 75ms/step - loss: 0.2613 - val_loss: 0.2629
Epoch 17/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2564 - val_loss: 0.2594
Epoch 18/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2526 - val_loss: 0.2565
Epoch 19/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2485 - val_loss: 0.2513
Epoch 20/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2452 - val_loss: 0.2567
Epoch 21/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2438 - val_loss: 0.2484
Epoch 22/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2388 - val_loss: 0.2477
Epoch 23/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2339 - val_loss: 0.2480
Epoch 24/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2310 - val_loss: 0.2440
Epoch 25/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2268 - val_loss: 0.2412
Epoch 26/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2235 - val_loss: 0.2390
Epoch 27/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2198 - val_loss: 0.2402
Epoch 28/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2171 - val_loss: 0.2371
Epoch 29/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2151 - val_loss: 0.2356
Epoch 30/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2129 - val_loss: 0.2343
Epoch 31/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2117 - val_loss: 0.2345
Epoch 32/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2111 - val_loss: 0.2342
Epoch 33/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2107 - val_loss: 0.2342
Epoch 34/100
93/93 [==============================] - 7s 76ms/step - loss: 0.2113 - val_loss: 0.2348
Epoch 35/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2119 - val_loss: 0.2345
Epoch 36/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2126 - val_loss: 0.2360
Epoch 37/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2134 - val_loss: 0.2347
Epoch 38/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2148 - val_loss: 0.2376
Epoch 39/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2163 - val_loss: 0.2390
Epoch 40/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2163 - val_loss: 0.2403
Epoch 41/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2159 - val_loss: 0.2396
Epoch 42/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2142 - val_loss: 0.2420
Epoch 43/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2139 - val_loss: 0.2369
Epoch 44/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2104 - val_loss: 0.2384
Epoch 45/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2079 - val_loss: 0.2342
Epoch 46/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2052 - val_loss: 0.2354
Epoch 47/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2016 - val_loss: 0.2353
Epoch 48/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1983 - val_loss: 0.2349
Epoch 49/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1968 - val_loss: 0.2304
Epoch 50/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1930 - val_loss: 0.2295
Epoch 51/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1902 - val_loss: 0.2287
Epoch 52/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1886 - val_loss: 0.2278
Epoch 53/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1869 - val_loss: 0.2279
Epoch 54/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1862 - val_loss: 0.2275
Epoch 55/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1858 - val_loss: 0.2274
Epoch 56/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1856 - val_loss: 0.2275
Epoch 57/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1858 - val_loss: 0.2277
Epoch 58/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1864 - val_loss: 0.2273
Epoch 59/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1874 - val_loss: 0.2284
Epoch 60/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1889 - val_loss: 0.2283
Epoch 61/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1899 - val_loss: 0.2301
Epoch 62/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1913 - val_loss: 0.2313
Epoch 63/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1931 - val_loss: 0.2346
Epoch 64/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1936 - val_loss: 0.2366
Epoch 65/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1939 - val_loss: 0.2333
Epoch 66/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1930 - val_loss: 0.2312
Epoch 67/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1917 - val_loss: 0.2326
Epoch 68/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1901 - val_loss: 0.2301
Epoch 69/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1875 - val_loss: 0.2305
Epoch 70/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1856 - val_loss: 0.2288
Epoch 71/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1826 - val_loss: 0.2293
Epoch 72/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1800 - val_loss: 0.2267
Epoch 73/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1776 - val_loss: 0.2257
Epoch 74/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1756 - val_loss: 0.2248
Epoch 75/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1737 - val_loss: 0.2247
Epoch 76/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1725 - val_loss: 0.2243
Epoch 77/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1715 - val_loss: 0.2242
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 78/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1714 - val_loss: 0.2242
Epoch 79/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1713 - val_loss: 0.2241
Epoch 80/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1716 - val_loss: 0.2237
Epoch 81/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1721 - val_loss: 0.2242
Epoch 82/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1730 - val_loss: 0.2250
Epoch 83/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1740 - val_loss: 0.2266
Epoch 84/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1758 - val_loss: 0.2290
Epoch 85/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1775 - val_loss: 0.2275
Epoch 86/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1786 - val_loss: 0.2310
Epoch 87/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1803 - val_loss: 0.2297
Epoch 88/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1812 - val_loss: 0.2320
Epoch 89/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1821 - val_loss: 0.2299
Epoch 90/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1808 - val_loss: 0.2305
Epoch 91/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1793 - val_loss: 0.2283
Epoch 92/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1769 - val_loss: 0.2299
Epoch 93/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1754 - val_loss: 0.2263
Epoch 94/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1731 - val_loss: 0.2253
Epoch 95/100
93/93 [==============================] - 7s 77ms/step - loss: 0.1702 - val_loss: 0.2254
Epoch 96/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1677 - val_loss: 0.2248
Epoch 97/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1660 - val_loss: 0.2236
Epoch 98/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1640 - val_loss: 0.2226
Epoch 99/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1633 - val_loss: 0.2225
Epoch 100/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1626 - val_loss: 0.2224
Min Validation Loss :  0.2224472463130951
Min Validation Epoch :  100
</pre></div>
</div>
<img alt="_images/openvaccine-model-training-augmentation_39_8.png" src="_images/openvaccine-model-training-augmentation_39_8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  4</span>
<span class=" -Color -Color-Yellow">#############################################</span>

|| Batch_size: 32 
|| n_layers: 2 
|| embed_dim: 250
|| cat_feature: 6 
|| num_features: 19
|| layers : [&#39;GRU&#39;, &#39;GRU&#39;] 
|| hidden_dim: [128, 128] 
|| dropout: [0.5, 0.5] 
|| sp_dropout: 0.2
|| number Augmented data Present in Val Data :  301
|| number Augmented data Present in Train Data :  1205
|| Data Lekage :  0
Epoch 1/100
93/93 [==============================] - 8s 91ms/step - loss: 0.5811 - val_loss: 0.5725
Epoch 2/100
93/93 [==============================] - 7s 71ms/step - loss: 0.4436 - val_loss: 0.3954
Epoch 3/100
93/93 [==============================] - 7s 74ms/step - loss: 0.3709 - val_loss: 0.3473
Epoch 4/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3468 - val_loss: 0.3353
Epoch 5/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3381 - val_loss: 0.3301
Epoch 6/100
93/93 [==============================] - 7s 75ms/step - loss: 0.3311 - val_loss: 0.3234
Epoch 7/100
93/93 [==============================] - 7s 73ms/step - loss: 0.3242 - val_loss: 0.3165
Epoch 8/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3171 - val_loss: 0.3111
Epoch 9/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3078 - val_loss: 0.3039
Epoch 10/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2996 - val_loss: 0.2919
Epoch 11/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2905 - val_loss: 0.2828
Epoch 12/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2833 - val_loss: 0.2735
Epoch 13/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2766 - val_loss: 0.2727
Epoch 14/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2714 - val_loss: 0.2644
Epoch 15/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2665 - val_loss: 0.2584
Epoch 16/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2624 - val_loss: 0.2557
Epoch 17/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2599 - val_loss: 0.2516
Epoch 18/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2548 - val_loss: 0.2533
Epoch 19/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2511 - val_loss: 0.2480
Epoch 20/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2473 - val_loss: 0.2442
Epoch 21/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2441 - val_loss: 0.2419
Epoch 22/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2396 - val_loss: 0.2377
Epoch 23/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2360 - val_loss: 0.2406
Epoch 24/100
93/93 [==============================] - 7s 75ms/step - loss: 0.2327 - val_loss: 0.2345
Epoch 25/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2290 - val_loss: 0.2353
Epoch 26/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2254 - val_loss: 0.2319
Epoch 27/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2218 - val_loss: 0.2308
Epoch 28/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2188 - val_loss: 0.2279
Epoch 29/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2161 - val_loss: 0.2268
Epoch 30/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2144 - val_loss: 0.2262
Epoch 31/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2131 - val_loss: 0.2266
Epoch 32/100
93/93 [==============================] - 7s 76ms/step - loss: 0.2126 - val_loss: 0.2261
Epoch 33/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2126 - val_loss: 0.2258
Epoch 34/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2131 - val_loss: 0.2263
Epoch 35/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2136 - val_loss: 0.2263
Epoch 36/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2144 - val_loss: 0.2265
Epoch 37/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2156 - val_loss: 0.2293
Epoch 38/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2169 - val_loss: 0.2274
Epoch 39/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2167 - val_loss: 0.2308
Epoch 40/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2181 - val_loss: 0.2302
Epoch 41/100
93/93 [==============================] - 7s 76ms/step - loss: 0.2180 - val_loss: 0.2285
Epoch 42/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2160 - val_loss: 0.2299
Epoch 43/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2147 - val_loss: 0.2336
Epoch 44/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2121 - val_loss: 0.2280
Epoch 45/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2094 - val_loss: 0.2286
Epoch 46/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2077 - val_loss: 0.2278
Epoch 47/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2036 - val_loss: 0.2259
Epoch 48/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2008 - val_loss: 0.2245
Epoch 49/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1975 - val_loss: 0.2226
Epoch 50/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1947 - val_loss: 0.2203
Epoch 51/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1920 - val_loss: 0.2211
Epoch 52/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1898 - val_loss: 0.2195
Epoch 53/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1885 - val_loss: 0.2196
Epoch 54/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1876 - val_loss: 0.2186
Epoch 55/100
93/93 [==============================] - 7s 70ms/step - loss: 0.1872 - val_loss: 0.2188
Epoch 56/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1872 - val_loss: 0.2188
Epoch 57/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1875 - val_loss: 0.2194
Epoch 58/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1880 - val_loss: 0.2195
Epoch 59/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1886 - val_loss: 0.2192
Epoch 60/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1896 - val_loss: 0.2219
Epoch 61/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1916 - val_loss: 0.2234
Epoch 62/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1927 - val_loss: 0.2239
Epoch 63/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1938 - val_loss: 0.2236
Epoch 64/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1946 - val_loss: 0.2258
Epoch 65/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1951 - val_loss: 0.2248
Epoch 66/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1952 - val_loss: 0.2231
Epoch 67/100
93/93 [==============================] - 7s 77ms/step - loss: 0.1936 - val_loss: 0.2219
Epoch 68/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1920 - val_loss: 0.2247
Epoch 69/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1898 - val_loss: 0.2231
Epoch 70/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1867 - val_loss: 0.2213
Epoch 71/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1845 - val_loss: 0.2197
Epoch 72/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1817 - val_loss: 0.2193
Epoch 73/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1787 - val_loss: 0.2181
Epoch 74/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1768 - val_loss: 0.2172
Epoch 75/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1752 - val_loss: 0.2167
Epoch 76/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1738 - val_loss: 0.2169
Epoch 77/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1730 - val_loss: 0.2163
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 78/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1725 - val_loss: 0.2162
Epoch 79/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1729 - val_loss: 0.2162
Epoch 80/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1731 - val_loss: 0.2166
Epoch 81/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1736 - val_loss: 0.2166
Epoch 82/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1744 - val_loss: 0.2170
Epoch 83/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1757 - val_loss: 0.2164
Epoch 84/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1771 - val_loss: 0.2203
Epoch 85/100
93/93 [==============================] - 7s 76ms/step - loss: 0.1787 - val_loss: 0.2204
Epoch 86/100
93/93 [==============================] - 7s 75ms/step - loss: 0.1805 - val_loss: 0.2217
Epoch 87/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1824 - val_loss: 0.2239
Epoch 88/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1830 - val_loss: 0.2223
Epoch 89/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1822 - val_loss: 0.2223
Epoch 90/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1818 - val_loss: 0.2229
Epoch 91/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1811 - val_loss: 0.2213
Epoch 92/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1791 - val_loss: 0.2199
Epoch 93/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1758 - val_loss: 0.2188
Epoch 94/100
93/93 [==============================] - 7s 76ms/step - loss: 0.1739 - val_loss: 0.2189
Epoch 95/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1718 - val_loss: 0.2176
Epoch 96/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1693 - val_loss: 0.2157
Epoch 97/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1672 - val_loss: 0.2155
Epoch 98/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1656 - val_loss: 0.2153
Epoch 99/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1643 - val_loss: 0.2154
Epoch 100/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1639 - val_loss: 0.2148
Min Validation Loss :  0.21476079523563385
Min Validation Epoch :  100
</pre></div>
</div>
<img alt="_images/openvaccine-model-training-augmentation_39_11.png" src="_images/openvaccine-model-training-augmentation_39_11.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Yellow">#############################################</span>
<span class=" -Color -Color-Yellow">###  Fold :  5</span>
<span class=" -Color -Color-Yellow">#############################################</span>

|| Batch_size: 32 
|| n_layers: 2 
|| embed_dim: 250
|| cat_feature: 6 
|| num_features: 19
|| layers : [&#39;GRU&#39;, &#39;GRU&#39;] 
|| hidden_dim: [128, 128] 
|| dropout: [0.5, 0.5] 
|| sp_dropout: 0.2
|| number Augmented data Present in Val Data :  301
|| number Augmented data Present in Train Data :  1205
|| Data Lekage :  0
Epoch 1/100
93/93 [==============================] - 8s 89ms/step - loss: 0.6790 - val_loss: 0.6815
Epoch 2/100
93/93 [==============================] - 7s 73ms/step - loss: 0.4603 - val_loss: 0.4060
Epoch 3/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3703 - val_loss: 0.3578
Epoch 4/100
93/93 [==============================] - 7s 74ms/step - loss: 0.3450 - val_loss: 0.3443
Epoch 5/100
93/93 [==============================] - 7s 74ms/step - loss: 0.3357 - val_loss: 0.3398
Epoch 6/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3301 - val_loss: 0.3345
Epoch 7/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3246 - val_loss: 0.3309
Epoch 8/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3178 - val_loss: 0.3210
Epoch 9/100
93/93 [==============================] - 7s 71ms/step - loss: 0.3098 - val_loss: 0.3122
Epoch 10/100
93/93 [==============================] - 7s 72ms/step - loss: 0.3003 - val_loss: 0.3026
Epoch 11/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2908 - val_loss: 0.2955
Epoch 12/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2838 - val_loss: 0.2861
Epoch 13/100
93/93 [==============================] - 7s 75ms/step - loss: 0.2775 - val_loss: 0.2836
Epoch 14/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2711 - val_loss: 0.2787
Epoch 15/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2672 - val_loss: 0.2712
Epoch 16/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2620 - val_loss: 0.2666
Epoch 17/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2592 - val_loss: 0.2620
Epoch 18/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2560 - val_loss: 0.2596
Epoch 19/100
93/93 [==============================] - 7s 70ms/step - loss: 0.2501 - val_loss: 0.2579
Epoch 20/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2475 - val_loss: 0.2518
Epoch 21/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2437 - val_loss: 0.2488
Epoch 22/100
93/93 [==============================] - 7s 75ms/step - loss: 0.2407 - val_loss: 0.2469
Epoch 23/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2369 - val_loss: 0.2537
Epoch 24/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2333 - val_loss: 0.2433
Epoch 25/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2285 - val_loss: 0.2411
Epoch 26/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2248 - val_loss: 0.2387
Epoch 27/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2213 - val_loss: 0.2402
Epoch 28/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2187 - val_loss: 0.2364
Epoch 29/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2163 - val_loss: 0.2345
Epoch 30/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2145 - val_loss: 0.2357
Epoch 31/100
93/93 [==============================] - 7s 76ms/step - loss: 0.2135 - val_loss: 0.2349
Epoch 32/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2126 - val_loss: 0.2348
Epoch 33/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2127 - val_loss: 0.2350
Epoch 34/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2130 - val_loss: 0.2348
Epoch 35/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2133 - val_loss: 0.2353
Epoch 36/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2143 - val_loss: 0.2364
Epoch 37/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2155 - val_loss: 0.2344
Epoch 38/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2165 - val_loss: 0.2366
Epoch 39/100
93/93 [==============================] - 7s 75ms/step - loss: 0.2174 - val_loss: 0.2395
Epoch 40/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2185 - val_loss: 0.2363
Epoch 41/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2176 - val_loss: 0.2449
Epoch 42/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2166 - val_loss: 0.2377
Epoch 43/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2148 - val_loss: 0.2376
Epoch 44/100
93/93 [==============================] - 7s 73ms/step - loss: 0.2110 - val_loss: 0.2343
Epoch 45/100
93/93 [==============================] - 7s 71ms/step - loss: 0.2092 - val_loss: 0.2371
Epoch 46/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2061 - val_loss: 0.2384
Epoch 47/100
93/93 [==============================] - 7s 72ms/step - loss: 0.2036 - val_loss: 0.2331
Epoch 48/100
93/93 [==============================] - 7s 74ms/step - loss: 0.2011 - val_loss: 0.2345
Epoch 49/100
93/93 [==============================] - 7s 76ms/step - loss: 0.1977 - val_loss: 0.2308
Epoch 50/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1947 - val_loss: 0.2303
Epoch 51/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1922 - val_loss: 0.2282
Epoch 52/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1899 - val_loss: 0.2286
Epoch 53/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1885 - val_loss: 0.2277
Epoch 54/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1874 - val_loss: 0.2272
Epoch 55/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1870 - val_loss: 0.2273
Epoch 56/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1873 - val_loss: 0.2273
Epoch 57/100
93/93 [==============================] - 7s 78ms/step - loss: 0.1874 - val_loss: 0.2277
Epoch 58/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1880 - val_loss: 0.2279
Epoch 59/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1888 - val_loss: 0.2272
Epoch 60/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1900 - val_loss: 0.2309
Epoch 61/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1910 - val_loss: 0.2312
Epoch 62/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1931 - val_loss: 0.2304
Epoch 63/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1937 - val_loss: 0.2326
Epoch 64/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1948 - val_loss: 0.2364
Epoch 65/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1955 - val_loss: 0.2301
Epoch 66/100
93/93 [==============================] - 7s 80ms/step - loss: 0.1956 - val_loss: 0.2319
Epoch 67/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1933 - val_loss: 0.2295
Epoch 68/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1918 - val_loss: 0.2302
Epoch 69/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1886 - val_loss: 0.2294
Epoch 70/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1870 - val_loss: 0.2302
Epoch 71/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1838 - val_loss: 0.2264
Epoch 72/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1810 - val_loss: 0.2255
Epoch 73/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1788 - val_loss: 0.2273
Epoch 74/100
93/93 [==============================] - 7s 76ms/step - loss: 0.1770 - val_loss: 0.2242
Epoch 75/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1748 - val_loss: 0.2235
Epoch 76/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1733 - val_loss: 0.2237
Epoch 77/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1727 - val_loss: 0.2235
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 78/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1726 - val_loss: 0.2235
Epoch 79/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1726 - val_loss: 0.2235
Epoch 80/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1731 - val_loss: 0.2230
Epoch 81/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1734 - val_loss: 0.2239
Epoch 82/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1742 - val_loss: 0.2254
Epoch 83/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1759 - val_loss: 0.2251
Epoch 84/100
93/93 [==============================] - 7s 76ms/step - loss: 0.1767 - val_loss: 0.2270
Epoch 85/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1792 - val_loss: 0.2279
Epoch 86/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1810 - val_loss: 0.2262
Epoch 87/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1816 - val_loss: 0.2305
Epoch 88/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1829 - val_loss: 0.2291
Epoch 89/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1825 - val_loss: 0.2291
Epoch 90/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1815 - val_loss: 0.2282
Epoch 91/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1801 - val_loss: 0.2263
Epoch 92/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1782 - val_loss: 0.2257
Epoch 93/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1764 - val_loss: 0.2253
Epoch 94/100
93/93 [==============================] - 7s 73ms/step - loss: 0.1741 - val_loss: 0.2236
Epoch 95/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1716 - val_loss: 0.2226
Epoch 96/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1689 - val_loss: 0.2239
Epoch 97/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1668 - val_loss: 0.2222
Epoch 98/100
93/93 [==============================] - 7s 71ms/step - loss: 0.1653 - val_loss: 0.2222
Epoch 99/100
93/93 [==============================] - 7s 74ms/step - loss: 0.1641 - val_loss: 0.2214
Epoch 100/100
93/93 [==============================] - 7s 72ms/step - loss: 0.1635 - val_loss: 0.2212
Min Validation Loss :  0.22124020755290985
Min Validation Epoch :  100
</pre></div>
</div>
<img alt="_images/openvaccine-model-training-augmentation_39_14.png" src="_images/openvaccine-model-training-augmentation_39_14.png" />
</div>
</div>
</div>
<div class="section" id="calculate-oof-score">
<h1>Calculate OOF Score :<a class="headerlink" href="#calculate-oof-score" title="Permalink to this headline">¬∂</a></h1>
<p>The OOF (out of fold) predictions are saved to disk. If you wish to ensemble multiple models, use the OOF to determine what are the best weights to blend your models with. Choose weights that maximize OOF CV score when used to blend OOF. Then use those same weights to blend your test predictions.</p>
<div class="section" id="overall-oof-score">
<h2>Overall OOF Score<a class="headerlink" href="#overall-oof-score" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">OOF</span> <span class="o">=</span> <span class="n">OOF</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;s_id&#39;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">OOF</span> <span class="o">=</span> <span class="n">OOF</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;s_id&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
<span class="n">OOF_score</span> <span class="o">=</span> <span class="n">MCRMSE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">OOF</span><span class="p">[</span><span class="n">target_eval_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">OOF</span><span class="p">[</span><span class="n">pred_eval_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overall OOF Score :&quot;</span><span class="p">,</span><span class="n">OOF_score</span><span class="p">)</span>
<span class="n">OOF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;OOf.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">OOF</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overall OOF Score : 0.24697195
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_seqpos</th>
      <th>id</th>
      <th>s_id</th>
      <th>reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>deg_pH10</th>
      <th>deg_50C</th>
      <th>pred_reactivity</th>
      <th>pred_deg_Mg_pH10</th>
      <th>pred_deg_Mg_50C</th>
      <th>pred_deg_pH10</th>
      <th>pred_deg_50C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id_001f94081_0</td>
      <td>id_001f94081</td>
      <td>0</td>
      <td>0.3297</td>
      <td>0.7556</td>
      <td>0.3581</td>
      <td>2.3375</td>
      <td>0.6382</td>
      <td>0.506454</td>
      <td>0.569681</td>
      <td>0.598764</td>
      <td>1.402838</td>
      <td>-0.043847</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id_001f94081_1</td>
      <td>id_001f94081</td>
      <td>1</td>
      <td>1.5693</td>
      <td>2.9830</td>
      <td>2.9683</td>
      <td>3.5060</td>
      <td>3.4773</td>
      <td>1.952811</td>
      <td>3.225294</td>
      <td>3.793018</td>
      <td>1.031866</td>
      <td>-0.159633</td>
    </tr>
    <tr>
      <th>12</th>
      <td>id_001f94081_2</td>
      <td>id_001f94081</td>
      <td>2</td>
      <td>1.1227</td>
      <td>0.2526</td>
      <td>0.2589</td>
      <td>0.3008</td>
      <td>0.9988</td>
      <td>1.226825</td>
      <td>0.179408</td>
      <td>0.282933</td>
      <td>0.764894</td>
      <td>-0.294644</td>
    </tr>
    <tr>
      <th>23</th>
      <td>id_001f94081_3</td>
      <td>id_001f94081</td>
      <td>3</td>
      <td>0.8686</td>
      <td>1.3789</td>
      <td>1.4552</td>
      <td>1.0108</td>
      <td>1.3228</td>
      <td>1.195442</td>
      <td>1.547208</td>
      <td>1.947785</td>
      <td>-0.098986</td>
      <td>0.578751</td>
    </tr>
    <tr>
      <th>34</th>
      <td>id_001f94081_4</td>
      <td>id_001f94081</td>
      <td>4</td>
      <td>0.7217</td>
      <td>0.6376</td>
      <td>0.7244</td>
      <td>0.2635</td>
      <td>0.7877</td>
      <td>0.859540</td>
      <td>0.640238</td>
      <td>0.746073</td>
      <td>-0.737271</td>
      <td>1.045121</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="oof-sn-filter-1">
<h2>OOF  SN_filter == 1<a class="headerlink" href="#oof-sn-filter-1" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">OOF_filter_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">train</span><span class="p">[[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">]],</span><span class="n">OOF</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
<span class="n">OOF_filter_1</span> <span class="o">=</span> <span class="n">OOF_filter_1</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;id_seqpos&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">OOF_filter_1</span> <span class="o">=</span> <span class="n">OOF_filter_1</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;s_id&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
<span class="n">OOF_filter_1</span> <span class="o">=</span> <span class="n">OOF_filter_1</span><span class="p">[</span><span class="n">OOF_filter_1</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">OOF_filter_1_score</span> <span class="o">=</span> <span class="n">MCRMSE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">OOF_filter_1</span><span class="p">[</span><span class="n">target_eval_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">OOF_filter_1</span><span class="p">[</span><span class="n">pred_eval_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OOF_public Score :&quot;</span><span class="p">,</span><span class="n">OOF_filter_1_score</span><span class="p">)</span>
<span class="n">OOF_filter_1</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;OOF_filter_1.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">OOF_filter_1</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OOF_public Score : 0.22198166
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_seqpos</th>
      <th>id</th>
      <th>SN_filter</th>
      <th>s_id</th>
      <th>reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>deg_pH10</th>
      <th>deg_50C</th>
      <th>pred_reactivity</th>
      <th>pred_deg_Mg_pH10</th>
      <th>pred_deg_Mg_50C</th>
      <th>pred_deg_pH10</th>
      <th>pred_deg_50C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id_001f94081_0</td>
      <td>id_001f94081</td>
      <td>1</td>
      <td>0</td>
      <td>0.3297</td>
      <td>0.7556</td>
      <td>0.3581</td>
      <td>2.3375</td>
      <td>0.6382</td>
      <td>0.506454</td>
      <td>0.569681</td>
      <td>0.598764</td>
      <td>1.402838</td>
      <td>-0.043847</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id_001f94081_1</td>
      <td>id_001f94081</td>
      <td>1</td>
      <td>1</td>
      <td>1.5693</td>
      <td>2.9830</td>
      <td>2.9683</td>
      <td>3.5060</td>
      <td>3.4773</td>
      <td>1.952811</td>
      <td>3.225294</td>
      <td>3.793018</td>
      <td>1.031866</td>
      <td>-0.159633</td>
    </tr>
    <tr>
      <th>12</th>
      <td>id_001f94081_2</td>
      <td>id_001f94081</td>
      <td>1</td>
      <td>2</td>
      <td>1.1227</td>
      <td>0.2526</td>
      <td>0.2589</td>
      <td>0.3008</td>
      <td>0.9988</td>
      <td>1.226825</td>
      <td>0.179408</td>
      <td>0.282933</td>
      <td>0.764894</td>
      <td>-0.294644</td>
    </tr>
    <tr>
      <th>23</th>
      <td>id_001f94081_3</td>
      <td>id_001f94081</td>
      <td>1</td>
      <td>3</td>
      <td>0.8686</td>
      <td>1.3789</td>
      <td>1.4552</td>
      <td>1.0108</td>
      <td>1.3228</td>
      <td>1.195442</td>
      <td>1.547208</td>
      <td>1.947785</td>
      <td>-0.098986</td>
      <td>0.578751</td>
    </tr>
    <tr>
      <th>34</th>
      <td>id_001f94081_4</td>
      <td>id_001f94081</td>
      <td>1</td>
      <td>4</td>
      <td>0.7217</td>
      <td>0.6376</td>
      <td>0.7244</td>
      <td>0.2635</td>
      <td>0.7877</td>
      <td>0.859540</td>
      <td>0.640238</td>
      <td>0.746073</td>
      <td>-0.737271</td>
      <td>1.045121</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="oof-sn-filter-0">
<h2>OOF  SN_filter == 0<a class="headerlink" href="#oof-sn-filter-0" title="Permalink to this headline">¬∂</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">OOF_filter_0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">train</span><span class="p">[[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">]],</span><span class="n">OOF</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
<span class="n">OOF_filter_0</span> <span class="o">=</span> <span class="n">OOF_filter_0</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;s_id&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
<span class="n">OOF_filter_0</span> <span class="o">=</span> <span class="n">OOF_filter_0</span><span class="p">[</span><span class="n">OOF_filter_0</span><span class="p">[</span><span class="s1">&#39;SN_filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">OOF_filter_0_score</span> <span class="o">=</span> <span class="n">MCRMSE</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">OOF_filter_0</span><span class="p">[</span><span class="n">target_eval_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">OOF_filter_0</span><span class="p">[</span><span class="n">pred_eval_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OOF_public Score :&quot;</span><span class="p">,</span><span class="n">OOF_filter_0_score</span><span class="p">)</span>
<span class="n">OOF_filter_0</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;OOF_filter_0.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">OOF_filter_0</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OOF_public Score : 0.29366112
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SN_filter</th>
      <th>id</th>
      <th>id_seqpos</th>
      <th>s_id</th>
      <th>reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>deg_pH10</th>
      <th>deg_50C</th>
      <th>pred_reactivity</th>
      <th>pred_deg_Mg_pH10</th>
      <th>pred_deg_Mg_50C</th>
      <th>pred_deg_pH10</th>
      <th>pred_deg_50C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>612</th>
      <td>0</td>
      <td>id_00fcc5cd1</td>
      <td>id_00fcc5cd1_0</td>
      <td>0</td>
      <td>0.7926</td>
      <td>1.1295</td>
      <td>2.0792</td>
      <td>-0.1863</td>
      <td>-0.5478</td>
      <td>0.924210</td>
      <td>0.882714</td>
      <td>0.699846</td>
      <td>-0.412075</td>
      <td>0.228747</td>
    </tr>
    <tr>
      <th>613</th>
      <td>0</td>
      <td>id_00fcc5cd1</td>
      <td>id_00fcc5cd1_1</td>
      <td>1</td>
      <td>2.4251</td>
      <td>1.1239</td>
      <td>5.0599</td>
      <td>2.6245</td>
      <td>0.6198</td>
      <td>2.407500</td>
      <td>2.962975</td>
      <td>2.610025</td>
      <td>0.187428</td>
      <td>0.480321</td>
    </tr>
    <tr>
      <th>614</th>
      <td>0</td>
      <td>id_00fcc5cd1</td>
      <td>id_00fcc5cd1_2</td>
      <td>2</td>
      <td>1.1071</td>
      <td>1.0301</td>
      <td>2.3826</td>
      <td>0.1026</td>
      <td>-0.2701</td>
      <td>1.514376</td>
      <td>1.183765</td>
      <td>1.635927</td>
      <td>0.787610</td>
      <td>0.437695</td>
    </tr>
    <tr>
      <th>615</th>
      <td>0</td>
      <td>id_00fcc5cd1</td>
      <td>id_00fcc5cd1_3</td>
      <td>3</td>
      <td>0.4379</td>
      <td>0.0000</td>
      <td>0.8223</td>
      <td>0.4123</td>
      <td>1.7043</td>
      <td>0.678217</td>
      <td>0.652593</td>
      <td>0.989920</td>
      <td>0.796818</td>
      <td>0.228244</td>
    </tr>
    <tr>
      <th>616</th>
      <td>0</td>
      <td>id_00fcc5cd1</td>
      <td>id_00fcc5cd1_4</td>
      <td>4</td>
      <td>0.3445</td>
      <td>0.7191</td>
      <td>0.0000</td>
      <td>0.8095</td>
      <td>0.8336</td>
      <td>0.583219</td>
      <td>0.463586</td>
      <td>0.427519</td>
      <td>1.211596</td>
      <td>-0.088493</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="save-stacking-data">
<h1>Save Stacking Data<a class="headerlink" href="#save-stacking-data" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stacking_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;stacking.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">stacking_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pred_reactivity</th>
      <th>pred_deg_Mg_pH10</th>
      <th>pred_deg_Mg_50C</th>
      <th>pred_deg_pH10</th>
      <th>pred_deg_50C</th>
      <th>id_seqpos</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.506454</td>
      <td>0.569681</td>
      <td>0.598764</td>
      <td>1.402838</td>
      <td>-0.043847</td>
      <td>id_001f94081_0</td>
      <td>id_001f94081</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.952811</td>
      <td>3.225294</td>
      <td>3.793018</td>
      <td>1.031866</td>
      <td>-0.159633</td>
      <td>id_001f94081_1</td>
      <td>id_001f94081</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.226825</td>
      <td>0.179408</td>
      <td>0.282933</td>
      <td>0.764894</td>
      <td>-0.294644</td>
      <td>id_001f94081_2</td>
      <td>id_001f94081</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.195442</td>
      <td>1.547208</td>
      <td>1.947785</td>
      <td>-0.098986</td>
      <td>0.578751</td>
      <td>id_001f94081_3</td>
      <td>id_001f94081</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.859540</td>
      <td>0.640238</td>
      <td>0.746073</td>
      <td>-0.737271</td>
      <td>1.045121</td>
      <td>id_001f94081_4</td>
      <td>id_001f94081</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="submit-to-kaggle">
<h1>Submit To Kaggle<a class="headerlink" href="#submit-to-kaggle" title="Permalink to this headline">¬∂</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;submission.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">submission</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_seqpos</th>
      <th>reactivity</th>
      <th>deg_Mg_pH10</th>
      <th>deg_Mg_50C</th>
      <th>deg_pH10</th>
      <th>deg_50C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id_00073f8be_0</td>
      <td>0.708363</td>
      <td>0.680277</td>
      <td>0.572540</td>
      <td>-0.038588</td>
      <td>0.197162</td>
    </tr>
    <tr>
      <th>1</th>
      <td>id_00073f8be_1</td>
      <td>2.448232</td>
      <td>3.259603</td>
      <td>3.337977</td>
      <td>0.403141</td>
      <td>0.455587</td>
    </tr>
    <tr>
      <th>2</th>
      <td>id_00073f8be_2</td>
      <td>1.436304</td>
      <td>0.502687</td>
      <td>0.639965</td>
      <td>0.058503</td>
      <td>-0.212436</td>
    </tr>
    <tr>
      <th>3</th>
      <td>id_00073f8be_3</td>
      <td>1.200515</td>
      <td>1.006197</td>
      <td>1.578012</td>
      <td>0.301830</td>
      <td>0.404742</td>
    </tr>
    <tr>
      <th>4</th>
      <td>id_00073f8be_4</td>
      <td>0.795663</td>
      <td>0.595126</td>
      <td>0.912262</td>
      <td>0.109406</td>
      <td>0.356488</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>No</p></th>
<th class="text-align:center head"><p>n_folds</p></th>
<th class="text-align:center head"><p>Window_features</p></th>
<th class="text-align:center head"><p>cat_feature</p></th>
<th class="text-align:center head"><p>num_features</p></th>
<th class="text-align:center head"><p>epochs</p></th>
<th class="text-align:center head"><p>BATCH_SIZE</p></th>
<th class="text-align:center head"><p>n_layers</p></th>
<th class="text-align:center head"><p>layers</p></th>
<th class="text-align:center head"><p>hidden_dim</p></th>
<th class="text-align:center head"><p>dropout</p></th>
<th class="text-align:center head"><p>sp_dropout</p></th>
<th class="text-align:center head"><p>embed_dim</p></th>
<th class="text-align:center head"><p>num_hidden_units</p></th>
<th class="text-align:center head"><p>OOF_score</p></th>
<th class="text-align:center head"><p>OOF_filter_1</p></th>
<th class="text-align:center head"><p>OOF_filter_0</p></th>
<th class="text-align:center head"><p>LB</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
<td class="text-align:center"><p></p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|No|OOF_score|OOF_filter_1 |OOF_filter_0|LB|n_folds|Window_features|cat_feature|num_features |epochs|BATCH_SIZE|&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;|-|</span><span class="si">{OOF_score}</span><span class="s2">|</span><span class="si">{OOF_filter_1_score}</span><span class="s2">|</span><span class="si">{OOF_filter_0_score}</span><span class="s2">|-|</span><span class="si">{n_folds}</span><span class="s2">|</span><span class="si">{Window_features}</span><span class="s2">|</span><span class="si">{cat_feature}</span><span class="s2">|</span><span class="si">{num_features}</span><span class="s2">|</span><span class="si">{epochs}</span><span class="s2">|</span><span class="si">{BATCH_SIZE}</span><span class="s2">|&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>|No|OOF_score|OOF_filter_1 |OOF_filter_0|LB|n_folds|Window_features|cat_feature|num_features |epochs|BATCH_SIZE|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|-|0.2469719499349594|0.22198165953159332|0.29366111755371094|-|5|True|6|19|100|32|
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Vatsal Parsaniya , Meet Ranoliya<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.30270b6e4c972e43c488.js"></script>


    
  </body>
</html>